---
alwaysApply: true
---

# Development flow
This document create a perfect workflow a developer should follow for this project, like how to add a new feature from planning to tests

## Planning
- Dont go writing code as soon as you read the requirements go do some research on that specific feature and how it can be implemented. Unless i have specified a specific method or tech to use for the feature you should figure out the best solution and then proceed with next step

## Dependencies Management with `poetry`
We use `poetry` to manage dependencies in our project. if you are new to poetry, you can read the documentation [here](https://python-poetry.org/docs/). or check few youtube videos about it.

## Manager script `manage.py` for common commands
This is a utility script that can be used to run the project, run migrations, and other commands.
If you think that a specific command is used often in the development process, add it to the script.
`manage.py` is created using tools like `click`. which is a library for creating command line interfaces in Python.

## Database
To make any change in the database you should use alembic migrations.
    - use `poetry run alembic migrate "<Message>"` to create a new migration.
    - use `poetry run alembic upgrade` to upgrade the database to the latest revision.
    - use `poetry run alembic downgrade` to downgrade the database to the latest revision.


## Logging
We use `loguru` for logging. it is a library for logging in Python.
use `from app.utils.logger import logger` to get a logger object.
use `logger.info` for major events, `logger.debug` for details, `logger.warning` for recoverable anomalies, `logger.error` for failures.

## Error Handling
- Use `AppHTTPException` for all errors. If you want to return some error response just raise this exception from anywhere in the code it will be handled and then a specific error response will be returned to the client.
- Make sure to use `logger.exception` to log the error.

## Environment Variables
- Use `from app import environment` to get the environment variables.
- Use `environment.<VARIABLE_NAME>` to get the value of the variable.
- If you want to add a new environment variable, add it to the `app/__init__.py` file.


## How to add a new feature
- Add new tables or fields to the database, you should add them to the `app/models` folder.
    - Any db queries (CRUD) should be done using either static methods or class methods of the model.
    - Use session from `from app.db.session import get_session` to get a session object.
        ```python
        from app.db.session import get_session
        async with get_session() as session:
            session.execute(...)
        ```
- Add proper pydantic models for the routes in `app/schemas` folder.  (Requests and Responses)
- Add new routes to the `app/routes` folder.
    - Use proper pydantic models for the routes in `app/schemas` folder.  (Requests and Responses)
    - Use proper dependency injection for the routes.
        - `Depends(get_current_user)` for current user
    - Make sure to add proper logging to the routes.
- Add new services to the `app/services` folder.
    - Dont add any business logic to the routes, add it to the services.
    - In services you can only do db queries using the static methods or class methods of the db models.
    - In services you can also do some business logic like validation, etc.
    - Errors can be raised from services and then handled in the routes.
    - Dont use dicts in services, use pydantic models or dataclasses.
    - Use functions in services instead of classes (Unless really required).
- Add new utils to the `app/utils` folder. (If required)



## Code rules
- Dont use `print` in the code, use `logger.info` instead.
- Use async/await properly in the code.
- Code should be properly formatted.
- Code should have proper type annotations.
- One router per feature/domain (users, orders, products, etc.)
- Use consistent naming conventions for endpoints and parameters
- Use guard clauses to handle edge cases and invalid inputs early
- Return early from functions to reduce nesting and improve readability
- Validate inputs at the beginning of functions before processing