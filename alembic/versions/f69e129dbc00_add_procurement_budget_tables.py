"""Add procurement budget tables

Revision ID: f69e129dbc00
Revises: chat_tables_20251127
Create Date: 2025-11-28 03:26:56.495658

"""
from __future__ import annotations

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql


revision: str = 'f69e129dbc00'
down_revision: Union[str, None] = 'chat_tables_20251127'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('employee_expenses',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('custom_id', sa.String(length=50), nullable=True),
    sa.Column('org_id', sa.UUID(), nullable=False),
    sa.Column('employee_id', sa.UUID(), nullable=False),
    sa.Column('expense_date', sa.DateTime(timezone=True), nullable=False),
    sa.Column('amount', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('category', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=False),
    sa.Column('project_code', sa.String(length=50), nullable=True),
    sa.Column('receipt_url', sa.String(length=500), nullable=True),
    sa.Column('receipt_uploaded', sa.Boolean(), nullable=False),
    sa.Column('status', sa.Enum('DRAFT', 'PENDING', 'APPROVED', 'REJECTED', 'REIMBURSED', name='expense_status'), nullable=False),
    sa.Column('approved_by', sa.UUID(), nullable=True),
    sa.Column('approved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('rejected_reason', sa.Text(), nullable=True),
    sa.Column('reimbursed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['approved_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['employee_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['org_id'], ['organizations.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_employee_expenses_custom_id'), 'employee_expenses', ['custom_id'], unique=True)
    op.create_index(op.f('ix_employee_expenses_employee_id'), 'employee_expenses', ['employee_id'], unique=False)
    op.create_index(op.f('ix_employee_expenses_id'), 'employee_expenses', ['id'], unique=False)
    op.create_index(op.f('ix_employee_expenses_org_id'), 'employee_expenses', ['org_id'], unique=False)
    op.create_index(op.f('ix_employee_expenses_project_code'), 'employee_expenses', ['project_code'], unique=False)
    op.create_index(op.f('ix_employee_expenses_status'), 'employee_expenses', ['status'], unique=False)
    op.create_table('procurement_budgets',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('org_id', sa.UUID(), nullable=False),
    sa.Column('budget_year', sa.String(length=4), nullable=False),
    sa.Column('status', sa.Enum('DRAFT', 'SUBMITTED', 'APPROVED', 'ACTIVE', 'ARCHIVED', name='procurement_budget_status'), nullable=False),
    sa.Column('total_budget', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('created_by', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['org_id'], ['organizations.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_procurement_budgets_budget_year'), 'procurement_budgets', ['budget_year'], unique=False)
    op.create_index(op.f('ix_procurement_budgets_created_by'), 'procurement_budgets', ['created_by'], unique=False)
    op.create_index(op.f('ix_procurement_budgets_id'), 'procurement_budgets', ['id'], unique=False)
    op.create_index(op.f('ix_procurement_budgets_org_id'), 'procurement_budgets', ['org_id'], unique=False)
    op.create_index(op.f('ix_procurement_budgets_status'), 'procurement_budgets', ['status'], unique=False)
    op.create_table('purchase_requisitions',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('custom_id', sa.String(length=50), nullable=True),
    sa.Column('org_id', sa.UUID(), nullable=False),
    sa.Column('requested_by', sa.UUID(), nullable=False),
    sa.Column('purchase_type', sa.Enum('OVERHEAD', 'PROJECT', name='purchase_type'), nullable=False),
    sa.Column('description', sa.Text(), nullable=False),
    sa.Column('category', sa.String(length=255), nullable=True),
    sa.Column('estimated_cost', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('vendor', sa.String(length=255), nullable=True),
    sa.Column('justification', sa.Text(), nullable=False),
    sa.Column('department', sa.String(length=100), nullable=False),
    sa.Column('project_code', sa.String(length=50), nullable=True),
    sa.Column('urgency', sa.Enum('LOW', 'MEDIUM', 'HIGH', name='urgency_level'), nullable=False),
    sa.Column('needed_by', sa.DateTime(timezone=True), nullable=True),
    sa.Column('status', sa.Enum('DRAFT', 'PENDING', 'APPROVED', 'REJECTED', 'PO_CREATED', name='requisition_status'), nullable=False),
    sa.Column('approved_by', sa.UUID(), nullable=True),
    sa.Column('approved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('rejection_reason', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['approved_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['org_id'], ['organizations.id'], ),
    sa.ForeignKeyConstraint(['requested_by'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_purchase_requisitions_custom_id'), 'purchase_requisitions', ['custom_id'], unique=True)
    op.create_index(op.f('ix_purchase_requisitions_id'), 'purchase_requisitions', ['id'], unique=False)
    op.create_index(op.f('ix_purchase_requisitions_org_id'), 'purchase_requisitions', ['org_id'], unique=False)
    op.create_index(op.f('ix_purchase_requisitions_project_code'), 'purchase_requisitions', ['project_code'], unique=False)
    op.create_index(op.f('ix_purchase_requisitions_requested_by'), 'purchase_requisitions', ['requested_by'], unique=False)
    op.create_index(op.f('ix_purchase_requisitions_status'), 'purchase_requisitions', ['status'], unique=False)
    op.create_table('procurement_budget_categories',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('budget_id', sa.UUID(), nullable=False),
    sa.Column('category_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('actual_last_year', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('actual_current_year', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('proposed_budget', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('ai_suggested_budget', sa.Numeric(precision=15, scale=2), nullable=True),
    sa.Column('ai_confidence', sa.Float(), nullable=True),
    sa.Column('market_growth_rate', sa.Float(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['budget_id'], ['procurement_budgets.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['category_id'], ['expense_categories.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_procurement_budget_categories_budget_id'), 'procurement_budget_categories', ['budget_id'], unique=False)
    op.create_index(op.f('ix_procurement_budget_categories_category_id'), 'procurement_budget_categories', ['category_id'], unique=False)
    op.create_index(op.f('ix_procurement_budget_categories_id'), 'procurement_budget_categories', ['id'], unique=False)
    op.create_table('purchase_orders',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('custom_id', sa.String(length=50), nullable=True),
    sa.Column('org_id', sa.UUID(), nullable=False),
    sa.Column('requisition_id', sa.UUID(), nullable=True),
    sa.Column('vendor_id', sa.UUID(), nullable=True),
    sa.Column('created_by', sa.UUID(), nullable=False),
    sa.Column('vendor_name', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=False),
    sa.Column('amount', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('project_code', sa.String(length=50), nullable=True),
    sa.Column('issue_date', sa.DateTime(timezone=True), nullable=False),
    sa.Column('due_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('expected_delivery_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('status', sa.Enum('ISSUED', 'PARTIALLY_FULFILLED', 'FULFILLED', 'INVOICED', 'PAID', 'CANCELLED', name='po_status'), nullable=False),
    sa.Column('terms_and_conditions', sa.Text(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['org_id'], ['organizations.id'], ),
    sa.ForeignKeyConstraint(['requisition_id'], ['purchase_requisitions.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    # Add vendor_id foreign key only if vendors table exists
    from sqlalchemy import inspect
    conn = op.get_bind()
    inspector = inspect(conn)
    tables = inspector.get_table_names()
    if 'vendors' in tables:
        op.create_foreign_key('fk_purchase_orders_vendor_id', 'purchase_orders', 'vendors', ['vendor_id'], ['id'])
    op.create_index(op.f('ix_purchase_orders_created_by'), 'purchase_orders', ['created_by'], unique=False)
    op.create_index(op.f('ix_purchase_orders_custom_id'), 'purchase_orders', ['custom_id'], unique=True)
    op.create_index(op.f('ix_purchase_orders_id'), 'purchase_orders', ['id'], unique=False)
    op.create_index(op.f('ix_purchase_orders_org_id'), 'purchase_orders', ['org_id'], unique=False)
    op.create_index(op.f('ix_purchase_orders_project_code'), 'purchase_orders', ['project_code'], unique=False)
    op.create_index(op.f('ix_purchase_orders_requisition_id'), 'purchase_orders', ['requisition_id'], unique=False)
    op.create_index(op.f('ix_purchase_orders_status'), 'purchase_orders', ['status'], unique=False)
    op.create_index(op.f('ix_purchase_orders_vendor_id'), 'purchase_orders', ['vendor_id'], unique=False)
    op.create_table('rfqs',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('custom_id', sa.String(length=50), nullable=True),
    sa.Column('org_id', sa.UUID(), nullable=False),
    sa.Column('requisition_id', sa.UUID(), nullable=True),
    sa.Column('created_by', sa.UUID(), nullable=False),
    sa.Column('title', sa.String(length=500), nullable=False),
    sa.Column('description', sa.Text(), nullable=False),
    sa.Column('category', sa.String(length=255), nullable=False),
    sa.Column('estimated_value', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('due_date', sa.DateTime(timezone=True), nullable=False),
    sa.Column('status', sa.Enum('DRAFT', 'SENT', 'RESPONSES_RECEIVED', 'EVALUATING', 'AWARDED', 'CLOSED', name='rfq_status'), nullable=False),
    sa.Column('sent_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('vendors_invited', sa.Integer(), nullable=False),
    sa.Column('responses_received', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['org_id'], ['organizations.id'], ),
    sa.ForeignKeyConstraint(['requisition_id'], ['purchase_requisitions.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_rfqs_created_by'), 'rfqs', ['created_by'], unique=False)
    op.create_index(op.f('ix_rfqs_custom_id'), 'rfqs', ['custom_id'], unique=True)
    op.create_index(op.f('ix_rfqs_id'), 'rfqs', ['id'], unique=False)
    op.create_index(op.f('ix_rfqs_org_id'), 'rfqs', ['org_id'], unique=False)
    op.create_index(op.f('ix_rfqs_requisition_id'), 'rfqs', ['requisition_id'], unique=False)
    op.create_index(op.f('ix_rfqs_status'), 'rfqs', ['status'], unique=False)
    op.create_table('delivery_milestones',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('po_id', sa.UUID(), nullable=False),
    sa.Column('milestone_name', sa.String(length=255), nullable=False),
    sa.Column('due_date', sa.DateTime(timezone=True), nullable=False),
    sa.Column('completed_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('status', sa.Enum('PENDING', 'IN_PROGRESS', 'COMPLETED', 'DELAYED', name='milestone_status'), nullable=False),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['po_id'], ['purchase_orders.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_delivery_milestones_id'), 'delivery_milestones', ['id'], unique=False)
    op.create_index(op.f('ix_delivery_milestones_po_id'), 'delivery_milestones', ['po_id'], unique=False)
    op.create_index(op.f('ix_delivery_milestones_status'), 'delivery_milestones', ['status'], unique=False)
    op.create_table('grns',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('custom_id', sa.String(length=50), nullable=True),
    sa.Column('org_id', sa.UUID(), nullable=False),
    sa.Column('po_id', sa.UUID(), nullable=False),
    sa.Column('received_by', sa.UUID(), nullable=False),
    sa.Column('grn_number', sa.String(length=100), nullable=False),
    sa.Column('received_date', sa.DateTime(timezone=True), nullable=False),
    sa.Column('items', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('total_amount', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('status', sa.Enum('DRAFT', 'SUBMITTED', 'VERIFIED', 'APPROVED', name='grn_status'), nullable=False),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['org_id'], ['organizations.id'], ),
    sa.ForeignKeyConstraint(['po_id'], ['purchase_orders.id'], ),
    sa.ForeignKeyConstraint(['received_by'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_grns_custom_id'), 'grns', ['custom_id'], unique=True)
    op.create_index(op.f('ix_grns_grn_number'), 'grns', ['grn_number'], unique=True)
    op.create_index(op.f('ix_grns_id'), 'grns', ['id'], unique=False)
    op.create_index(op.f('ix_grns_org_id'), 'grns', ['org_id'], unique=False)
    op.create_index(op.f('ix_grns_po_id'), 'grns', ['po_id'], unique=False)
    op.create_index(op.f('ix_grns_received_by'), 'grns', ['received_by'], unique=False)
    op.create_index(op.f('ix_grns_status'), 'grns', ['status'], unique=False)
    op.create_table('procurement_budget_subcategories',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('category_id', sa.UUID(), nullable=False),
    sa.Column('subcategory_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('actual_last_year', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('actual_current_year', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('proposed_budget', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('ai_suggested_budget', sa.Numeric(precision=15, scale=2), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['category_id'], ['procurement_budget_categories.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['subcategory_id'], ['expense_categories.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_procurement_budget_subcategories_category_id'), 'procurement_budget_subcategories', ['category_id'], unique=False)
    op.create_index(op.f('ix_procurement_budget_subcategories_id'), 'procurement_budget_subcategories', ['id'], unique=False)
    op.create_index(op.f('ix_procurement_budget_subcategories_subcategory_id'), 'procurement_budget_subcategories', ['subcategory_id'], unique=False)
    op.create_table('rfq_responses',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('rfq_id', sa.UUID(), nullable=False),
    sa.Column('vendor_id', sa.UUID(), nullable=False),
    sa.Column('quoted_amount', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('delivery_time', sa.String(length=255), nullable=False),
    sa.Column('terms', sa.Text(), nullable=True),
    sa.Column('score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('submitted_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['rfq_id'], ['rfqs.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    # Add vendor_id foreign key only if vendors table exists
    from sqlalchemy import inspect
    conn = op.get_bind()
    inspector = inspect(conn)
    tables = inspector.get_table_names()
    if 'vendors' in tables:
        op.create_foreign_key('fk_rfq_responses_vendor_id', 'rfq_responses', 'vendors', ['vendor_id'], ['id'])
    op.create_index(op.f('ix_rfq_responses_id'), 'rfq_responses', ['id'], unique=False)
    op.create_index(op.f('ix_rfq_responses_rfq_id'), 'rfq_responses', ['rfq_id'], unique=False)
    op.create_index(op.f('ix_rfq_responses_status'), 'rfq_responses', ['status'], unique=False)
    op.create_index(op.f('ix_rfq_responses_vendor_id'), 'rfq_responses', ['vendor_id'], unique=False)
    op.create_table('vendor_invoices',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('org_id', sa.UUID(), nullable=False),
    sa.Column('po_id', sa.UUID(), nullable=True),
    sa.Column('vendor_id', sa.UUID(), nullable=True),
    sa.Column('grn_id', sa.UUID(), nullable=True),
    sa.Column('invoice_number', sa.String(length=100), nullable=False),
    sa.Column('vendor_name', sa.String(length=255), nullable=False),
    sa.Column('amount', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('invoice_date', sa.DateTime(timezone=True), nullable=False),
    sa.Column('due_date', sa.DateTime(timezone=True), nullable=False),
    sa.Column('po_amount', sa.Numeric(precision=15, scale=2), nullable=True),
    sa.Column('grn_amount', sa.Numeric(precision=15, scale=2), nullable=True),
    sa.Column('variance', sa.Numeric(precision=15, scale=2), nullable=True),
    sa.Column('status', sa.Enum('PENDING', 'MATCHED', 'APPROVED', 'PAID', 'EXCEPTION', name='invoice_status'), nullable=False),
    sa.Column('matching_status', sa.Enum('PERFECT_MATCH', 'PARTIAL_MATCH', 'NO_MATCH', 'EXCEPTION', name='matching_status'), nullable=False),
    sa.Column('invoice_file_url', sa.String(length=500), nullable=True),
    sa.Column('fraud_detected', sa.Boolean(), nullable=False),
    sa.Column('fraud_reasons', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['grn_id'], ['grns.id'], ),
    sa.ForeignKeyConstraint(['org_id'], ['organizations.id'], ),
    sa.ForeignKeyConstraint(['po_id'], ['purchase_orders.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    # Add vendor_id foreign key only if vendors table exists
    if 'vendors' in tables:
        op.create_foreign_key('fk_vendor_invoices_vendor_id', 'vendor_invoices', 'vendors', ['vendor_id'], ['id'])
    op.create_index(op.f('ix_vendor_invoices_grn_id'), 'vendor_invoices', ['grn_id'], unique=False)
    op.create_index(op.f('ix_vendor_invoices_id'), 'vendor_invoices', ['id'], unique=False)
    op.create_index(op.f('ix_vendor_invoices_invoice_number'), 'vendor_invoices', ['invoice_number'], unique=True)
    op.create_index(op.f('ix_vendor_invoices_matching_status'), 'vendor_invoices', ['matching_status'], unique=False)
    op.create_index(op.f('ix_vendor_invoices_org_id'), 'vendor_invoices', ['org_id'], unique=False)
    op.create_index(op.f('ix_vendor_invoices_po_id'), 'vendor_invoices', ['po_id'], unique=False)
    op.create_index(op.f('ix_vendor_invoices_status'), 'vendor_invoices', ['status'], unique=False)
    op.create_index(op.f('ix_vendor_invoices_vendor_id'), 'vendor_invoices', ['vendor_id'], unique=False)
    op.drop_index(op.f('idx_password_reset_tokens_email'), table_name='password_reset_tokens')
    op.drop_index(op.f('idx_password_reset_tokens_expires_at'), table_name='password_reset_tokens')
    op.drop_index(op.f('idx_password_reset_tokens_is_used'), table_name='password_reset_tokens')
    op.drop_index(op.f('idx_password_reset_tokens_otp'), table_name='password_reset_tokens')
    op.drop_index(op.f('idx_password_reset_tokens_user_id'), table_name='password_reset_tokens')
    op.drop_table('password_reset_tokens')
    op.drop_index(op.f('idx_account_team_account_id'), table_name='account_team')
    op.drop_index(op.f('idx_account_team_employee_id'), table_name='account_team')
    op.drop_index(op.f('idx_account_team_unique'), table_name='account_team', postgresql_where='(removed_at IS NULL)')
    op.create_index(op.f('ix_account_team_account_id'), 'account_team', ['account_id'], unique=False)
    op.create_index(op.f('ix_account_team_employee_id'), 'account_team', ['employee_id'], unique=False)
    op.create_index(op.f('ix_account_team_id'), 'account_team', ['id'], unique=False)
    op.drop_index(op.f('idx_accounts_created_by'), table_name='accounts')
    op.drop_index(op.f('idx_accounts_updated_by'), table_name='accounts')
    op.alter_column('ai_agentic_templates', 'tags',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               type_=postgresql.ARRAY(sa.String()),
               existing_nullable=True,
               existing_server_default=sa.text("'{}'::text[]"))
    op.alter_column('ai_agentic_templates', 'assigned_modules',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               type_=postgresql.ARRAY(sa.String()),
               existing_nullable=True,
               existing_server_default=sa.text("'{}'::text[]"))
    op.alter_column('ai_agentic_templates', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('ai_agentic_templates', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index(op.f('idx_ai_agentic_templates_category'), table_name='ai_agentic_templates')
    op.drop_index(op.f('idx_ai_agentic_templates_is_active'), table_name='ai_agentic_templates')
    op.drop_index(op.f('idx_ai_agentic_templates_org_id'), table_name='ai_agentic_templates')
    op.create_index(op.f('ix_ai_agentic_templates_category'), 'ai_agentic_templates', ['category'], unique=False)
    op.create_index(op.f('ix_ai_agentic_templates_id'), 'ai_agentic_templates', ['id'], unique=False)
    op.create_index(op.f('ix_ai_agentic_templates_org_id'), 'ai_agentic_templates', ['org_id'], unique=False)
    op.alter_column('candidates', 'ai_raw_json',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='Full Gemini API response',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_experience',
               existing_type=sa.TEXT(),
               comment='AI-generated experience summary',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_skills',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               type_=sa.ARRAY(sa.String()),
               comment='Extracted skills',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_sectors',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               type_=sa.ARRAY(sa.String()),
               comment='Sector expertise',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_services',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               type_=sa.ARRAY(sa.String()),
               comment='Services provided',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_project_types',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               type_=sa.ARRAY(sa.String()),
               comment='Project type experience',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_doc_checklist',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='Required documents: {doc_type: {required: bool, uploaded: bool, url: str}}',
               existing_nullable=True)
    op.alter_column('candidates', 'skills_matrix',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='Detailed skills with proficiency: [{skill, proficiency, years}]',
               existing_nullable=True)
    op.alter_column('candidates', 'project_experience',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='Projects with duration and value: [{name, duration, value, role}]',
               existing_nullable=True)
    op.alter_column('candidates', 'education',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='Degrees, universities, years',
               existing_nullable=True)
    op.alter_column('candidates', 'certifications',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               type_=sa.ARRAY(sa.String()),
               existing_nullable=True)
    op.alter_column('candidates', 'ai_match_percentage',
               existing_type=sa.INTEGER(),
               comment='0-100 match score',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_match_reasons',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               type_=sa.ARRAY(sa.String()),
               existing_nullable=True)
    op.alter_column('candidates', 'ai_confidence_score',
               existing_type=sa.NUMERIC(precision=3, scale=2),
               comment='0.00-1.00',
               existing_nullable=True)
    op.alter_column('candidates', 'status',
               existing_type=sa.VARCHAR(length=20),
               nullable=False,
               existing_server_default=sa.text("'pending'::character varying"))
    op.alter_column('candidates', 'compensation_type',
               existing_type=sa.VARCHAR(length=20),
               comment='hourly or salary',
               existing_nullable=True)
    op.alter_column('candidates', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('candidates', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_constraint(op.f('candidates_candidate_number_key'), 'candidates', type_='unique')
    op.create_index(op.f('ix_candidates_candidate_number'), 'candidates', ['candidate_number'], unique=True)
    op.create_index(op.f('ix_candidates_company_id'), 'candidates', ['company_id'], unique=False)
    op.create_index(op.f('ix_candidates_email'), 'candidates', ['email'], unique=False)
    op.create_index(op.f('ix_candidates_id'), 'candidates', ['id'], unique=False)
    op.create_index(op.f('ix_candidates_status'), 'candidates', ['status'], unique=False)
    op.create_index(op.f('ix_chat_messages_id'), 'chat_messages', ['id'], unique=False)
    op.create_index(op.f('ix_chat_sessions_id'), 'chat_sessions', ['id'], unique=False)
    op.create_index(op.f('ix_delivery_model_templates_id'), 'delivery_model_templates', ['id'], unique=False)
    op.alter_column('employees', 'ai_match_reasons',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               type_=sa.ARRAY(sa.String()),
               existing_nullable=True)
    op.drop_index(op.f('idx_employees_company_status'), table_name='employees')
    op.drop_index(op.f('idx_employees_email'), table_name='employees')
    op.create_index(op.f('ix_employees_id'), 'employees', ['id'], unique=False)
    op.alter_column('expense_categories', 'is_active',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('true'))
    op.alter_column('expense_categories', 'is_default',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('expense_categories', 'display_order',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.alter_column('expense_categories', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('expense_categories', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_index(op.f('idx_expense_categories_category_type'), table_name='expense_categories')
    op.drop_index(op.f('idx_expense_categories_display_order'), table_name='expense_categories')
    op.drop_index(op.f('idx_expense_categories_is_active'), table_name='expense_categories')
    op.drop_index(op.f('idx_expense_categories_name'), table_name='expense_categories')
    op.drop_index(op.f('idx_expense_categories_parent_id'), table_name='expense_categories')
    op.create_index(op.f('ix_expense_categories_category_type'), 'expense_categories', ['category_type'], unique=False)
    op.create_index(op.f('ix_expense_categories_id'), 'expense_categories', ['id'], unique=False)
    op.create_index(op.f('ix_expense_categories_is_active'), 'expense_categories', ['is_active'], unique=False)
    op.create_index(op.f('ix_expense_categories_name'), 'expense_categories', ['name'], unique=False)
    op.create_index(op.f('ix_expense_categories_parent_id'), 'expense_categories', ['parent_id'], unique=False)
    op.alter_column('finance_annual_budgets', 'target_growth_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('15.0'))
    op.alter_column('finance_annual_budgets', 'total_revenue_target',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_annual_budgets', 'total_expense_budget',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_annual_budgets', 'status',
               existing_type=sa.VARCHAR(length=50),
               nullable=False,
               existing_server_default=sa.text("'draft'::character varying"))
    op.alter_column('finance_annual_budgets', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_annual_budgets', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_index(op.f('idx_finance_annual_budgets_org'), table_name='finance_annual_budgets')
    op.drop_index(op.f('idx_finance_annual_budgets_year'), table_name='finance_annual_budgets')
    op.create_index(op.f('ix_finance_annual_budgets_budget_year'), 'finance_annual_budgets', ['budget_year'], unique=False)
    op.create_index(op.f('ix_finance_annual_budgets_id'), 'finance_annual_budgets', ['id'], unique=False)
    op.create_index(op.f('ix_finance_annual_budgets_org_id'), 'finance_annual_budgets', ['org_id'], unique=False)
    op.drop_constraint(op.f('finance_annual_budgets_org_id_fkey'), 'finance_annual_budgets', type_='foreignkey')
    op.drop_constraint(op.f('finance_annual_budgets_created_by_fkey'), 'finance_annual_budgets', type_='foreignkey')
    op.create_foreign_key(None, 'finance_annual_budgets', 'organizations', ['org_id'], ['id'])
    op.alter_column('finance_business_units', 'revenue',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_business_units', 'expense',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_business_units', 'profit',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_business_units', 'headcount',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.alter_column('finance_business_units', 'margin_percent',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_business_units', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_business_units', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_index(op.f('idx_finance_business_units_budget'), table_name='finance_business_units')
    op.create_index(op.f('ix_finance_business_units_id'), 'finance_business_units', ['id'], unique=False)
    op.alter_column('finance_expense_lines', 'target',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_expense_lines', 'variance',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_expense_lines', 'display_order',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.alter_column('finance_expense_lines', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_expense_lines', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_index(op.f('idx_finance_expense_lines_budget'), table_name='finance_expense_lines')
    op.create_index(op.f('ix_finance_expense_lines_id'), 'finance_expense_lines', ['id'], unique=False)
    op.alter_column('finance_forecasts', 'market_growth_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_forecasts', 'inflation_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_forecasts', 'seasonal_adjustment',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('finance_forecasts', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_forecasts', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_index(op.f('idx_finance_forecasts_created_at'), table_name='finance_forecasts')
    op.drop_index(op.f('idx_finance_forecasts_created_by'), table_name='finance_forecasts')
    op.drop_index(op.f('idx_finance_forecasts_forecasting_model'), table_name='finance_forecasts')
    op.drop_index(op.f('idx_finance_forecasts_org_id'), table_name='finance_forecasts')
    op.create_index(op.f('ix_finance_forecasts_id'), 'finance_forecasts', ['id'], unique=False)
    op.create_index(op.f('ix_finance_forecasts_org_id'), 'finance_forecasts', ['org_id'], unique=False)
    op.drop_constraint(op.f('finance_forecasts_org_id_fkey'), 'finance_forecasts', type_='foreignkey')
    op.create_foreign_key(None, 'finance_forecasts', 'organizations', ['org_id'], ['id'])
    op.alter_column('finance_kpi_targets', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_kpi_targets', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_index(op.f('idx_finance_kpi_targets_scenario'), table_name='finance_kpi_targets')
    op.create_index(op.f('ix_finance_kpi_targets_id'), 'finance_kpi_targets', ['id'], unique=False)
    op.alter_column('finance_planning_configs', 'planning_period_years',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('3'))
    op.alter_column('finance_planning_configs', 'base_year_revenue',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_planning_configs', 'base_year_expenses',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_planning_configs', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_planning_configs', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_index(op.f('idx_finance_planning_configs_org'), table_name='finance_planning_configs')
    op.create_index(op.f('ix_finance_planning_configs_id'), 'finance_planning_configs', ['id'], unique=False)
    op.create_index(op.f('ix_finance_planning_configs_org_id'), 'finance_planning_configs', ['org_id'], unique=False)
    op.drop_constraint(op.f('finance_planning_configs_org_id_fkey'), 'finance_planning_configs', type_='foreignkey')
    op.drop_constraint(op.f('finance_planning_configs_created_by_fkey'), 'finance_planning_configs', type_='foreignkey')
    op.create_foreign_key(None, 'finance_planning_configs', 'organizations', ['org_id'], ['id'])
    op.alter_column('finance_planning_scenarios', 'investment_level',
               existing_type=sa.VARCHAR(length=50),
               nullable=False,
               existing_server_default=sa.text("'Medium'::character varying"))
    op.alter_column('finance_planning_scenarios', 'bonus_threshold',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('90.0'))
    op.alter_column('finance_planning_scenarios', 'risk_level',
               existing_type=sa.VARCHAR(length=50),
               nullable=False,
               existing_server_default=sa.text("'Medium'::character varying"))
    op.alter_column('finance_planning_scenarios', 'active',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('finance_planning_scenarios', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_planning_scenarios', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_constraint(op.f('finance_planning_scenarios_scenario_key_key'), 'finance_planning_scenarios', type_='unique')
    op.drop_index(op.f('idx_finance_planning_scenarios_key'), table_name='finance_planning_scenarios')
    op.drop_index(op.f('idx_finance_planning_scenarios_org'), table_name='finance_planning_scenarios')
    op.create_index(op.f('ix_finance_planning_scenarios_id'), 'finance_planning_scenarios', ['id'], unique=False)
    op.create_index(op.f('ix_finance_planning_scenarios_org_id'), 'finance_planning_scenarios', ['org_id'], unique=False)
    op.create_index(op.f('ix_finance_planning_scenarios_scenario_key'), 'finance_planning_scenarios', ['scenario_key'], unique=True)
    op.drop_constraint(op.f('finance_planning_scenarios_created_by_fkey'), 'finance_planning_scenarios', type_='foreignkey')
    op.drop_constraint(op.f('finance_planning_scenarios_org_id_fkey'), 'finance_planning_scenarios', type_='foreignkey')
    op.create_foreign_key(None, 'finance_planning_scenarios', 'organizations', ['org_id'], ['id'])
    op.alter_column('finance_projections', 'revenue',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_projections', 'expenses',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_projections', 'profit',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_projections', 'margin_percent',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_projections', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_projections', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_index(op.f('idx_finance_projections_scenario'), table_name='finance_projections')
    op.create_index(op.f('ix_finance_projections_id'), 'finance_projections', ['id'], unique=False)
    op.alter_column('finance_revenue_lines', 'target',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_revenue_lines', 'variance',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_revenue_lines', 'display_order',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.alter_column('finance_revenue_lines', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_revenue_lines', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_index(op.f('idx_finance_revenue_lines_budget'), table_name='finance_revenue_lines')
    op.create_index(op.f('ix_finance_revenue_lines_id'), 'finance_revenue_lines', ['id'], unique=False)
    op.drop_index(op.f('ix_opportunities_temp_reviewer_id'), table_name='opportunities_temp')
    op.drop_constraint(op.f('opportunities_temp_reviewer_id_fkey'), 'opportunities_temp', type_='foreignkey')
    op.drop_constraint(op.f('opportunities_temp_org_id_fkey'), 'opportunities_temp', type_='foreignkey')
    op.create_foreign_key(None, 'opportunities_temp', 'users', ['reviewer_id'], ['id'])
    op.create_foreign_key(None, 'opportunities_temp', 'organizations', ['org_id'], ['id'])
    op.drop_constraint(op.f('opportunity_agent_runs_org_id_fkey'), 'opportunity_agent_runs', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_agent_runs', 'organizations', ['org_id'], ['id'])
    op.drop_constraint(op.f('opportunity_agents_org_id_fkey'), 'opportunity_agents', type_='foreignkey')
    op.drop_constraint(op.f('opportunity_agents_created_by_fkey'), 'opportunity_agents', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_agents', 'organizations', ['org_id'], ['id'])
    op.create_foreign_key(None, 'opportunity_agents', 'users', ['created_by'], ['id'])
    op.create_index(op.f('ix_opportunity_competitors_id'), 'opportunity_competitors', ['id'], unique=False)
    op.drop_constraint(op.f('opportunity_competitors_opportunity_id_fkey'), 'opportunity_competitors', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_competitors', 'opportunities', ['opportunity_id'], ['id'])
    op.create_index(op.f('ix_opportunity_delivery_models_id'), 'opportunity_delivery_models', ['id'], unique=False)
    op.drop_constraint(op.f('opportunity_delivery_models_opportunity_id_fkey'), 'opportunity_delivery_models', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_delivery_models', 'opportunities', ['opportunity_id'], ['id'])
    op.alter_column('opportunity_documents', 'file_name',
               existing_type=sa.VARCHAR(length=255),
               nullable=False)
    op.alter_column('opportunity_documents', 'original_name',
               existing_type=sa.VARCHAR(length=255),
               nullable=False)
    op.alter_column('opportunity_documents', 'file_type',
               existing_type=sa.VARCHAR(length=100),
               nullable=False)
    op.alter_column('opportunity_documents', 'file_size',
               existing_type=sa.INTEGER(),
               nullable=False)
    op.alter_column('opportunity_documents', 'category',
               existing_type=sa.VARCHAR(length=100),
               nullable=False,
               existing_server_default=sa.text("'Documents & Reports'::character varying"))
    op.alter_column('opportunity_documents', 'purpose',
               existing_type=sa.VARCHAR(length=100),
               nullable=False,
               existing_server_default=sa.text("'Project Reference'::character varying"))
    op.alter_column('opportunity_documents', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.create_index(op.f('ix_opportunity_documents_id'), 'opportunity_documents', ['id'], unique=False)
    op.drop_constraint(op.f('opportunity_documents_opportunity_id_fkey'), 'opportunity_documents', type_='foreignkey')
    op.drop_constraint(op.f('opportunity_documents_uploaded_by_fkey'), 'opportunity_documents', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_documents', 'opportunities', ['opportunity_id'], ['id'])
    op.drop_column('opportunity_documents', 'document_url')
    op.drop_column('opportunity_documents', 'created_at')
    op.drop_column('opportunity_documents', 'document_name')
    op.drop_column('opportunity_documents', 'uploaded_by')
    op.drop_column('opportunity_documents', 'document_type')
    op.create_index(op.f('ix_opportunity_drivers_id'), 'opportunity_drivers', ['id'], unique=False)
    op.drop_constraint(op.f('opportunity_drivers_opportunity_id_fkey'), 'opportunity_drivers', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_drivers', 'opportunities', ['opportunity_id'], ['id'])
    op.create_index(op.f('ix_opportunity_financials_id'), 'opportunity_financials', ['id'], unique=False)
    op.drop_constraint(op.f('opportunity_financials_opportunity_id_fkey'), 'opportunity_financials', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_financials', 'opportunities', ['opportunity_id'], ['id'])
    op.create_index(op.f('ix_opportunity_legal_checklists_id'), 'opportunity_legal_checklists', ['id'], unique=False)
    op.drop_constraint(op.f('opportunity_legal_checklists_opportunity_id_fkey'), 'opportunity_legal_checklists', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_legal_checklists', 'opportunities', ['opportunity_id'], ['id'])
    op.create_index(op.f('ix_opportunity_overviews_id'), 'opportunity_overviews', ['id'], unique=False)
    op.drop_constraint(op.f('opportunity_overviews_opportunity_id_fkey'), 'opportunity_overviews', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_overviews', 'opportunities', ['opportunity_id'], ['id'])
    op.create_index(op.f('ix_opportunity_references_id'), 'opportunity_references', ['id'], unique=False)
    op.drop_constraint(op.f('opportunity_references_opportunity_id_fkey'), 'opportunity_references', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_references', 'opportunities', ['opportunity_id'], ['id'])
    op.create_index(op.f('ix_opportunity_risks_id'), 'opportunity_risks', ['id'], unique=False)
    op.drop_constraint(op.f('opportunity_risks_opportunity_id_fkey'), 'opportunity_risks', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_risks', 'opportunities', ['opportunity_id'], ['id'])
    op.drop_constraint(op.f('opportunity_scrape_history_org_id_fkey'), 'opportunity_scrape_history', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_scrape_history', 'organizations', ['org_id'], ['id'])
    op.drop_constraint(op.f('opportunity_sources_created_by_fkey'), 'opportunity_sources', type_='foreignkey')
    op.drop_constraint(op.f('opportunity_sources_org_id_fkey'), 'opportunity_sources', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_sources', 'users', ['created_by'], ['id'])
    op.create_foreign_key(None, 'opportunity_sources', 'organizations', ['org_id'], ['id'])
    op.create_index(op.f('ix_opportunity_stakeholders_id'), 'opportunity_stakeholders', ['id'], unique=False)
    op.drop_constraint(op.f('opportunity_stakeholders_opportunity_id_fkey'), 'opportunity_stakeholders', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_stakeholders', 'opportunities', ['opportunity_id'], ['id'])
    op.create_index(op.f('ix_opportunity_strategies_id'), 'opportunity_strategies', ['id'], unique=False)
    op.drop_constraint(op.f('opportunity_strategies_opportunity_id_fkey'), 'opportunity_strategies', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_strategies', 'opportunities', ['opportunity_id'], ['id'])
    op.create_index(op.f('ix_opportunity_team_members_id'), 'opportunity_team_members', ['id'], unique=False)
    op.drop_constraint(op.f('opportunity_team_members_opportunity_id_fkey'), 'opportunity_team_members', type_='foreignkey')
    op.create_foreign_key(None, 'opportunity_team_members', 'opportunities', ['opportunity_id'], ['id'])
    op.drop_index(op.f('ix_proposal_approvals_sequence'), table_name='proposal_approvals')
    op.create_index(op.f('ix_proposal_approvals_id'), 'proposal_approvals', ['id'], unique=False)
    op.drop_index(op.f('ix_proposal_documents_category'), table_name='proposal_documents')
    op.drop_index(op.f('ix_proposal_documents_uploaded_by'), table_name='proposal_documents')
    op.create_index(op.f('ix_proposal_documents_id'), 'proposal_documents', ['id'], unique=False)
    op.drop_index(op.f('ix_proposal_sections_section_type'), table_name='proposal_sections')
    op.create_index(op.f('ix_proposal_sections_id'), 'proposal_sections', ['id'], unique=False)
    op.create_index(op.f('ix_proposals_id'), 'proposals', ['id'], unique=False)
    op.drop_index(op.f('idx_resource_utilization_resource_id'), table_name='resource_utilization')
    op.drop_index(op.f('ix_resource_utilization_resource_id'), table_name='resource_utilization')
    op.drop_constraint(op.f('resource_utilization_resource_id_fkey'), 'resource_utilization', type_='foreignkey')
    op.create_foreign_key(None, 'resource_utilization', 'employees', ['resource_id'], ['id'])
    op.drop_index(op.f('idx_resumes_employee'), table_name='resumes')
    op.create_index(op.f('ix_resumes_id'), 'resumes', ['id'], unique=False)
    op.drop_index(op.f('idx_staff_allocations_plan_id'), table_name='staff_allocations')
    op.drop_index(op.f('idx_staff_allocations_resource_id'), table_name='staff_allocations')
    op.drop_index(op.f('ix_staff_allocations_resource_id'), table_name='staff_allocations')
    op.drop_index(op.f('ix_staff_allocations_staff_plan_id'), table_name='staff_allocations')
    op.drop_constraint(op.f('staff_allocations_staff_plan_id_fkey'), 'staff_allocations', type_='foreignkey')
    op.drop_constraint(op.f('staff_allocations_resource_id_fkey'), 'staff_allocations', type_='foreignkey')
    op.create_foreign_key(None, 'staff_allocations', 'employees', ['resource_id'], ['id'])
    op.create_foreign_key(None, 'staff_allocations', 'staff_plans', ['staff_plan_id'], ['id'])
    op.drop_column('staff_allocations', 'initial_escalation_rate')
    op.drop_column('staff_allocations', 'escalation_effective_month')
    op.drop_index(op.f('idx_staff_plans_org_id'), table_name='staff_plans')
    op.drop_index(op.f('idx_staff_plans_project_id'), table_name='staff_plans')
    op.drop_index(op.f('idx_staff_plans_status'), table_name='staff_plans')
    op.drop_index(op.f('ix_staff_plans_project_id'), table_name='staff_plans')
    op.drop_index(op.f('ix_staff_plans_status'), table_name='staff_plans')
    op.create_index(op.f('ix_staff_plans_org_id'), 'staff_plans', ['org_id'], unique=False)
    op.drop_constraint(op.f('staff_plans_org_id_fkey'), 'staff_plans', type_='foreignkey')
    op.drop_constraint(op.f('staff_plans_project_id_fkey'), 'staff_plans', type_='foreignkey')
    op.create_foreign_key(None, 'staff_plans', 'organizations', ['org_id'], ['id'])
    op.create_foreign_key(None, 'staff_plans', 'opportunities', ['project_id'], ['id'])
    op.alter_column('survey_distributions', 'survey_link',
               existing_type=sa.TEXT(),
               type_=sa.String(length=500),
               existing_nullable=True)
    op.alter_column('survey_distributions', 'is_sent',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('survey_distributions', 'is_completed',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('survey_distributions', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index(op.f('idx_survey_distributions_account_id'), table_name='survey_distributions')
    op.drop_index(op.f('idx_survey_distributions_contact_id'), table_name='survey_distributions')
    op.drop_index(op.f('idx_survey_distributions_survey_id'), table_name='survey_distributions')
    op.create_foreign_key(None, 'survey_distributions', 'employees', ['employee_id'], ['id'], ondelete='CASCADE')
    op.alter_column('survey_responses', 'response_data',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=False)
    op.alter_column('survey_responses', 'finished',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('false'))
    op.alter_column('survey_responses', 'meta',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('survey_responses', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index(op.f('idx_survey_responses_account_id'), table_name='survey_responses')
    op.drop_index(op.f('idx_survey_responses_contact_id'), table_name='survey_responses')
    op.drop_index(op.f('idx_survey_responses_survey_id'), table_name='survey_responses')
    op.drop_constraint(op.f('survey_responses_response_code_key'), 'survey_responses', type_='unique')
    op.create_index(op.f('ix_survey_responses_response_code'), 'survey_responses', ['response_code'], unique=True)
    op.create_foreign_key(None, 'survey_responses', 'employees', ['employee_id'], ['id'], ondelete='CASCADE')
    op.drop_column('survey_responses', 'completed_at')
    op.alter_column('surveys', 'questions',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('surveys', 'settings',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=sa.JSON(),
               existing_nullable=True)
    op.alter_column('surveys', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index(op.f('idx_surveys_org_id'), table_name='surveys')
    op.drop_index(op.f('idx_surveys_status'), table_name='surveys')
    op.drop_constraint(op.f('surveys_survey_code_key'), 'surveys', type_='unique')
    op.create_index(op.f('ix_surveys_id'), 'surveys', ['id'], unique=False)
    op.create_index(op.f('ix_surveys_survey_code'), 'surveys', ['survey_code'], unique=True)
    op.drop_index(op.f('idx_users_username'), table_name='users')
    op.drop_constraint(op.f('users_username_key'), 'users', type_='unique')
    op.create_index(op.f('ix_users_username'), 'users', ['username'], unique=True)
    # Modify vendors table only if it exists
    if 'vendors' in tables:
        try:
            op.drop_constraint(op.f('vendors_email_key'), 'vendors', type_='unique')
        except:
            pass
        try:
            op.drop_index(op.f('ix_vendors_email'), table_name='vendors')
        except:
            pass
        op.create_index(op.f('ix_vendors_email'), 'vendors', ['email'], unique=True)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_vendors_email'), table_name='vendors')
    op.create_index(op.f('ix_vendors_email'), 'vendors', ['email'], unique=False)
    op.create_unique_constraint(op.f('vendors_email_key'), 'vendors', ['email'], postgresql_nulls_not_distinct=False)
    op.drop_index(op.f('ix_users_username'), table_name='users')
    op.create_unique_constraint(op.f('users_username_key'), 'users', ['username'], postgresql_nulls_not_distinct=False)
    op.create_index(op.f('idx_users_username'), 'users', ['username'], unique=False)
    op.drop_index(op.f('ix_surveys_survey_code'), table_name='surveys')
    op.drop_index(op.f('ix_surveys_id'), table_name='surveys')
    op.create_unique_constraint(op.f('surveys_survey_code_key'), 'surveys', ['survey_code'], postgresql_nulls_not_distinct=False)
    op.create_index(op.f('idx_surveys_status'), 'surveys', ['status'], unique=False)
    op.create_index(op.f('idx_surveys_org_id'), 'surveys', ['org_id'], unique=False)
    op.alter_column('surveys', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('surveys', 'settings',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('surveys', 'questions',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.add_column('survey_responses', sa.Column('completed_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
    op.drop_constraint(None, 'survey_responses', type_='foreignkey')
    op.drop_index(op.f('ix_survey_responses_response_code'), table_name='survey_responses')
    op.create_unique_constraint(op.f('survey_responses_response_code_key'), 'survey_responses', ['response_code'], postgresql_nulls_not_distinct=False)
    op.create_index(op.f('idx_survey_responses_survey_id'), 'survey_responses', ['survey_id'], unique=False)
    op.create_index(op.f('idx_survey_responses_contact_id'), 'survey_responses', ['contact_id'], unique=False)
    op.create_index(op.f('idx_survey_responses_account_id'), 'survey_responses', ['account_id'], unique=False)
    op.alter_column('survey_responses', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('survey_responses', 'meta',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('survey_responses', 'finished',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('survey_responses', 'response_data',
               existing_type=sa.JSON(),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=False)
    op.drop_constraint(None, 'survey_distributions', type_='foreignkey')
    op.create_index(op.f('idx_survey_distributions_survey_id'), 'survey_distributions', ['survey_id'], unique=False)
    op.create_index(op.f('idx_survey_distributions_contact_id'), 'survey_distributions', ['contact_id'], unique=False)
    op.create_index(op.f('idx_survey_distributions_account_id'), 'survey_distributions', ['account_id'], unique=False)
    op.alter_column('survey_distributions', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('survey_distributions', 'is_completed',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('survey_distributions', 'is_sent',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('survey_distributions', 'survey_link',
               existing_type=sa.String(length=500),
               type_=sa.TEXT(),
               existing_nullable=True)
    op.drop_constraint(None, 'staff_plans', type_='foreignkey')
    op.drop_constraint(None, 'staff_plans', type_='foreignkey')
    op.create_foreign_key(op.f('staff_plans_project_id_fkey'), 'staff_plans', 'opportunities', ['project_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(op.f('staff_plans_org_id_fkey'), 'staff_plans', 'organizations', ['org_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_staff_plans_org_id'), table_name='staff_plans')
    op.create_index(op.f('ix_staff_plans_status'), 'staff_plans', ['status'], unique=False)
    op.create_index(op.f('ix_staff_plans_project_id'), 'staff_plans', ['project_id'], unique=False)
    op.create_index(op.f('idx_staff_plans_status'), 'staff_plans', ['status'], unique=False)
    op.create_index(op.f('idx_staff_plans_project_id'), 'staff_plans', ['project_id'], unique=False)
    op.create_index(op.f('idx_staff_plans_org_id'), 'staff_plans', ['org_id'], unique=False)
    op.add_column('staff_allocations', sa.Column('escalation_effective_month', sa.INTEGER(), autoincrement=False, nullable=True))
    op.add_column('staff_allocations', sa.Column('initial_escalation_rate', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True))
    op.drop_constraint(None, 'staff_allocations', type_='foreignkey')
    op.drop_constraint(None, 'staff_allocations', type_='foreignkey')
    op.create_foreign_key(op.f('staff_allocations_resource_id_fkey'), 'staff_allocations', 'employees', ['resource_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(op.f('staff_allocations_staff_plan_id_fkey'), 'staff_allocations', 'staff_plans', ['staff_plan_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_staff_allocations_staff_plan_id'), 'staff_allocations', ['staff_plan_id'], unique=False)
    op.create_index(op.f('ix_staff_allocations_resource_id'), 'staff_allocations', ['resource_id'], unique=False)
    op.create_index(op.f('idx_staff_allocations_resource_id'), 'staff_allocations', ['resource_id'], unique=False)
    op.create_index(op.f('idx_staff_allocations_plan_id'), 'staff_allocations', ['staff_plan_id'], unique=False)
    op.drop_index(op.f('ix_resumes_id'), table_name='resumes')
    op.create_index(op.f('idx_resumes_employee'), 'resumes', ['employee_id'], unique=False)
    op.drop_constraint(None, 'resource_utilization', type_='foreignkey')
    op.create_foreign_key(op.f('resource_utilization_resource_id_fkey'), 'resource_utilization', 'employees', ['resource_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_resource_utilization_resource_id'), 'resource_utilization', ['resource_id'], unique=False)
    op.create_index(op.f('idx_resource_utilization_resource_id'), 'resource_utilization', ['resource_id'], unique=False)
    op.drop_index(op.f('ix_proposals_id'), table_name='proposals')
    op.drop_index(op.f('ix_proposal_sections_id'), table_name='proposal_sections')
    op.create_index(op.f('ix_proposal_sections_section_type'), 'proposal_sections', ['section_type'], unique=False)
    op.drop_index(op.f('ix_proposal_documents_id'), table_name='proposal_documents')
    op.create_index(op.f('ix_proposal_documents_uploaded_by'), 'proposal_documents', ['uploaded_by'], unique=False)
    op.create_index(op.f('ix_proposal_documents_category'), 'proposal_documents', ['category'], unique=False)
    op.drop_index(op.f('ix_proposal_approvals_id'), table_name='proposal_approvals')
    op.create_index(op.f('ix_proposal_approvals_sequence'), 'proposal_approvals', ['sequence'], unique=False)
    op.drop_constraint(None, 'opportunity_team_members', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_team_members_opportunity_id_fkey'), 'opportunity_team_members', 'opportunities', ['opportunity_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_opportunity_team_members_id'), table_name='opportunity_team_members')
    op.drop_constraint(None, 'opportunity_strategies', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_strategies_opportunity_id_fkey'), 'opportunity_strategies', 'opportunities', ['opportunity_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_opportunity_strategies_id'), table_name='opportunity_strategies')
    op.drop_constraint(None, 'opportunity_stakeholders', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_stakeholders_opportunity_id_fkey'), 'opportunity_stakeholders', 'opportunities', ['opportunity_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_opportunity_stakeholders_id'), table_name='opportunity_stakeholders')
    op.drop_constraint(None, 'opportunity_sources', type_='foreignkey')
    op.drop_constraint(None, 'opportunity_sources', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_sources_org_id_fkey'), 'opportunity_sources', 'organizations', ['org_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(op.f('opportunity_sources_created_by_fkey'), 'opportunity_sources', 'users', ['created_by'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'opportunity_scrape_history', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_scrape_history_org_id_fkey'), 'opportunity_scrape_history', 'organizations', ['org_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'opportunity_risks', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_risks_opportunity_id_fkey'), 'opportunity_risks', 'opportunities', ['opportunity_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_opportunity_risks_id'), table_name='opportunity_risks')
    op.drop_constraint(None, 'opportunity_references', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_references_opportunity_id_fkey'), 'opportunity_references', 'opportunities', ['opportunity_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_opportunity_references_id'), table_name='opportunity_references')
    op.drop_constraint(None, 'opportunity_overviews', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_overviews_opportunity_id_fkey'), 'opportunity_overviews', 'opportunities', ['opportunity_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_opportunity_overviews_id'), table_name='opportunity_overviews')
    op.drop_constraint(None, 'opportunity_legal_checklists', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_legal_checklists_opportunity_id_fkey'), 'opportunity_legal_checklists', 'opportunities', ['opportunity_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_opportunity_legal_checklists_id'), table_name='opportunity_legal_checklists')
    op.drop_constraint(None, 'opportunity_financials', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_financials_opportunity_id_fkey'), 'opportunity_financials', 'opportunities', ['opportunity_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_opportunity_financials_id'), table_name='opportunity_financials')
    op.drop_constraint(None, 'opportunity_drivers', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_drivers_opportunity_id_fkey'), 'opportunity_drivers', 'opportunities', ['opportunity_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_opportunity_drivers_id'), table_name='opportunity_drivers')
    op.add_column('opportunity_documents', sa.Column('document_type', sa.VARCHAR(length=50), autoincrement=False, nullable=True))
    op.add_column('opportunity_documents', sa.Column('uploaded_by', sa.UUID(), autoincrement=False, nullable=True))
    op.add_column('opportunity_documents', sa.Column('document_name', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
    op.add_column('opportunity_documents', sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False))
    op.add_column('opportunity_documents', sa.Column('document_url', sa.TEXT(), autoincrement=False, nullable=True))
    op.drop_constraint(None, 'opportunity_documents', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_documents_uploaded_by_fkey'), 'opportunity_documents', 'users', ['uploaded_by'], ['id'])
    op.create_foreign_key(op.f('opportunity_documents_opportunity_id_fkey'), 'opportunity_documents', 'opportunities', ['opportunity_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_opportunity_documents_id'), table_name='opportunity_documents')
    op.alter_column('opportunity_documents', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('opportunity_documents', 'purpose',
               existing_type=sa.VARCHAR(length=100),
               nullable=True,
               existing_server_default=sa.text("'Project Reference'::character varying"))
    op.alter_column('opportunity_documents', 'category',
               existing_type=sa.VARCHAR(length=100),
               nullable=True,
               existing_server_default=sa.text("'Documents & Reports'::character varying"))
    op.alter_column('opportunity_documents', 'file_size',
               existing_type=sa.INTEGER(),
               nullable=True)
    op.alter_column('opportunity_documents', 'file_type',
               existing_type=sa.VARCHAR(length=100),
               nullable=True)
    op.alter_column('opportunity_documents', 'original_name',
               existing_type=sa.VARCHAR(length=255),
               nullable=True)
    op.alter_column('opportunity_documents', 'file_name',
               existing_type=sa.VARCHAR(length=255),
               nullable=True)
    op.drop_constraint(None, 'opportunity_delivery_models', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_delivery_models_opportunity_id_fkey'), 'opportunity_delivery_models', 'opportunities', ['opportunity_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_opportunity_delivery_models_id'), table_name='opportunity_delivery_models')
    op.drop_constraint(None, 'opportunity_competitors', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_competitors_opportunity_id_fkey'), 'opportunity_competitors', 'opportunities', ['opportunity_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_opportunity_competitors_id'), table_name='opportunity_competitors')
    op.drop_constraint(None, 'opportunity_agents', type_='foreignkey')
    op.drop_constraint(None, 'opportunity_agents', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_agents_created_by_fkey'), 'opportunity_agents', 'users', ['created_by'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(op.f('opportunity_agents_org_id_fkey'), 'opportunity_agents', 'organizations', ['org_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'opportunity_agent_runs', type_='foreignkey')
    op.create_foreign_key(op.f('opportunity_agent_runs_org_id_fkey'), 'opportunity_agent_runs', 'organizations', ['org_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'opportunities_temp', type_='foreignkey')
    op.drop_constraint(None, 'opportunities_temp', type_='foreignkey')
    op.create_foreign_key(op.f('opportunities_temp_org_id_fkey'), 'opportunities_temp', 'organizations', ['org_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(op.f('opportunities_temp_reviewer_id_fkey'), 'opportunities_temp', 'users', ['reviewer_id'], ['id'], ondelete='SET NULL')
    op.create_index(op.f('ix_opportunities_temp_reviewer_id'), 'opportunities_temp', ['reviewer_id'], unique=False)
    op.drop_index(op.f('ix_finance_revenue_lines_id'), table_name='finance_revenue_lines')
    op.create_index(op.f('idx_finance_revenue_lines_budget'), 'finance_revenue_lines', ['budget_id'], unique=False)
    op.alter_column('finance_revenue_lines', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_revenue_lines', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_revenue_lines', 'display_order',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.alter_column('finance_revenue_lines', 'variance',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_revenue_lines', 'target',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.drop_index(op.f('ix_finance_projections_id'), table_name='finance_projections')
    op.create_index(op.f('idx_finance_projections_scenario'), 'finance_projections', ['scenario_id'], unique=False)
    op.alter_column('finance_projections', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_projections', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_projections', 'margin_percent',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_projections', 'profit',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_projections', 'expenses',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_projections', 'revenue',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.drop_constraint(None, 'finance_planning_scenarios', type_='foreignkey')
    op.create_foreign_key(op.f('finance_planning_scenarios_org_id_fkey'), 'finance_planning_scenarios', 'organizations', ['org_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(op.f('finance_planning_scenarios_created_by_fkey'), 'finance_planning_scenarios', 'users', ['created_by'], ['id'], ondelete='SET NULL')
    op.drop_index(op.f('ix_finance_planning_scenarios_scenario_key'), table_name='finance_planning_scenarios')
    op.drop_index(op.f('ix_finance_planning_scenarios_org_id'), table_name='finance_planning_scenarios')
    op.drop_index(op.f('ix_finance_planning_scenarios_id'), table_name='finance_planning_scenarios')
    op.create_index(op.f('idx_finance_planning_scenarios_org'), 'finance_planning_scenarios', ['org_id'], unique=False)
    op.create_index(op.f('idx_finance_planning_scenarios_key'), 'finance_planning_scenarios', ['scenario_key'], unique=False)
    op.create_unique_constraint(op.f('finance_planning_scenarios_scenario_key_key'), 'finance_planning_scenarios', ['scenario_key'], postgresql_nulls_not_distinct=False)
    op.alter_column('finance_planning_scenarios', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_planning_scenarios', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_planning_scenarios', 'active',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('finance_planning_scenarios', 'risk_level',
               existing_type=sa.VARCHAR(length=50),
               nullable=True,
               existing_server_default=sa.text("'Medium'::character varying"))
    op.alter_column('finance_planning_scenarios', 'bonus_threshold',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('90.0'))
    op.alter_column('finance_planning_scenarios', 'investment_level',
               existing_type=sa.VARCHAR(length=50),
               nullable=True,
               existing_server_default=sa.text("'Medium'::character varying"))
    op.drop_constraint(None, 'finance_planning_configs', type_='foreignkey')
    op.create_foreign_key(op.f('finance_planning_configs_created_by_fkey'), 'finance_planning_configs', 'users', ['created_by'], ['id'], ondelete='SET NULL')
    op.create_foreign_key(op.f('finance_planning_configs_org_id_fkey'), 'finance_planning_configs', 'organizations', ['org_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_finance_planning_configs_org_id'), table_name='finance_planning_configs')
    op.drop_index(op.f('ix_finance_planning_configs_id'), table_name='finance_planning_configs')
    op.create_index(op.f('idx_finance_planning_configs_org'), 'finance_planning_configs', ['org_id'], unique=False)
    op.alter_column('finance_planning_configs', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_planning_configs', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_planning_configs', 'base_year_expenses',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_planning_configs', 'base_year_revenue',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_planning_configs', 'planning_period_years',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('3'))
    op.drop_index(op.f('ix_finance_kpi_targets_id'), table_name='finance_kpi_targets')
    op.create_index(op.f('idx_finance_kpi_targets_scenario'), 'finance_kpi_targets', ['scenario_id'], unique=False)
    op.alter_column('finance_kpi_targets', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_kpi_targets', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_constraint(None, 'finance_forecasts', type_='foreignkey')
    op.create_foreign_key(op.f('finance_forecasts_org_id_fkey'), 'finance_forecasts', 'organizations', ['org_id'], ['id'], ondelete='SET NULL')
    op.drop_index(op.f('ix_finance_forecasts_org_id'), table_name='finance_forecasts')
    op.drop_index(op.f('ix_finance_forecasts_id'), table_name='finance_forecasts')
    op.create_index(op.f('idx_finance_forecasts_org_id'), 'finance_forecasts', ['org_id'], unique=False)
    op.create_index(op.f('idx_finance_forecasts_forecasting_model'), 'finance_forecasts', ['forecasting_model'], unique=False)
    op.create_index(op.f('idx_finance_forecasts_created_by'), 'finance_forecasts', ['created_by'], unique=False)
    op.create_index(op.f('idx_finance_forecasts_created_at'), 'finance_forecasts', [sa.literal_column('created_at DESC')], unique=False)
    op.alter_column('finance_forecasts', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_forecasts', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_forecasts', 'seasonal_adjustment',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('finance_forecasts', 'inflation_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_forecasts', 'market_growth_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.drop_index(op.f('ix_finance_expense_lines_id'), table_name='finance_expense_lines')
    op.create_index(op.f('idx_finance_expense_lines_budget'), 'finance_expense_lines', ['budget_id'], unique=False)
    op.alter_column('finance_expense_lines', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_expense_lines', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_expense_lines', 'display_order',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.alter_column('finance_expense_lines', 'variance',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_expense_lines', 'target',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.drop_index(op.f('ix_finance_business_units_id'), table_name='finance_business_units')
    op.create_index(op.f('idx_finance_business_units_budget'), 'finance_business_units', ['budget_id'], unique=False)
    op.alter_column('finance_business_units', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_business_units', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_business_units', 'margin_percent',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_business_units', 'headcount',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.alter_column('finance_business_units', 'profit',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_business_units', 'expense',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_business_units', 'revenue',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.drop_constraint(None, 'finance_annual_budgets', type_='foreignkey')
    op.create_foreign_key(op.f('finance_annual_budgets_created_by_fkey'), 'finance_annual_budgets', 'users', ['created_by'], ['id'], ondelete='SET NULL')
    op.create_foreign_key(op.f('finance_annual_budgets_org_id_fkey'), 'finance_annual_budgets', 'organizations', ['org_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_finance_annual_budgets_org_id'), table_name='finance_annual_budgets')
    op.drop_index(op.f('ix_finance_annual_budgets_id'), table_name='finance_annual_budgets')
    op.drop_index(op.f('ix_finance_annual_budgets_budget_year'), table_name='finance_annual_budgets')
    op.create_index(op.f('idx_finance_annual_budgets_year'), 'finance_annual_budgets', ['budget_year'], unique=False)
    op.create_index(op.f('idx_finance_annual_budgets_org'), 'finance_annual_budgets', ['org_id'], unique=False)
    op.alter_column('finance_annual_budgets', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_annual_budgets', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('finance_annual_budgets', 'status',
               existing_type=sa.VARCHAR(length=50),
               nullable=True,
               existing_server_default=sa.text("'draft'::character varying"))
    op.alter_column('finance_annual_budgets', 'total_expense_budget',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_annual_budgets', 'total_revenue_target',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('0.0'))
    op.alter_column('finance_annual_budgets', 'target_growth_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               existing_server_default=sa.text('15.0'))
    op.drop_index(op.f('ix_expense_categories_parent_id'), table_name='expense_categories')
    op.drop_index(op.f('ix_expense_categories_name'), table_name='expense_categories')
    op.drop_index(op.f('ix_expense_categories_is_active'), table_name='expense_categories')
    op.drop_index(op.f('ix_expense_categories_id'), table_name='expense_categories')
    op.drop_index(op.f('ix_expense_categories_category_type'), table_name='expense_categories')
    op.create_index(op.f('idx_expense_categories_parent_id'), 'expense_categories', ['parent_id'], unique=False)
    op.create_index(op.f('idx_expense_categories_name'), 'expense_categories', ['name'], unique=False)
    op.create_index(op.f('idx_expense_categories_is_active'), 'expense_categories', ['is_active'], unique=False)
    op.create_index(op.f('idx_expense_categories_display_order'), 'expense_categories', ['display_order'], unique=False)
    op.create_index(op.f('idx_expense_categories_category_type'), 'expense_categories', ['category_type'], unique=False)
    op.alter_column('expense_categories', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('expense_categories', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('expense_categories', 'display_order',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.alter_column('expense_categories', 'is_default',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('false'))
    op.alter_column('expense_categories', 'is_active',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('true'))
    op.drop_index(op.f('ix_employees_id'), table_name='employees')
    op.create_index(op.f('idx_employees_email'), 'employees', ['email'], unique=False)
    op.create_index(op.f('idx_employees_company_status'), 'employees', ['company_id', 'status'], unique=False)
    op.alter_column('employees', 'ai_match_reasons',
               existing_type=sa.ARRAY(sa.String()),
               type_=postgresql.ARRAY(sa.TEXT()),
               existing_nullable=True)
    op.drop_index(op.f('ix_delivery_model_templates_id'), table_name='delivery_model_templates')
    op.drop_index(op.f('ix_chat_sessions_id'), table_name='chat_sessions')
    op.drop_index(op.f('ix_chat_messages_id'), table_name='chat_messages')
    op.drop_index(op.f('ix_candidates_status'), table_name='candidates')
    op.drop_index(op.f('ix_candidates_id'), table_name='candidates')
    op.drop_index(op.f('ix_candidates_email'), table_name='candidates')
    op.drop_index(op.f('ix_candidates_company_id'), table_name='candidates')
    op.drop_index(op.f('ix_candidates_candidate_number'), table_name='candidates')
    op.create_unique_constraint(op.f('candidates_candidate_number_key'), 'candidates', ['candidate_number'], postgresql_nulls_not_distinct=False)
    op.alter_column('candidates', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('candidates', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('candidates', 'compensation_type',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='hourly or salary',
               existing_nullable=True)
    op.alter_column('candidates', 'status',
               existing_type=sa.VARCHAR(length=20),
               nullable=True,
               existing_server_default=sa.text("'pending'::character varying"))
    op.alter_column('candidates', 'ai_confidence_score',
               existing_type=sa.NUMERIC(precision=3, scale=2),
               comment=None,
               existing_comment='0.00-1.00',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_match_reasons',
               existing_type=sa.ARRAY(sa.String()),
               type_=postgresql.ARRAY(sa.TEXT()),
               existing_nullable=True)
    op.alter_column('candidates', 'ai_match_percentage',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='0-100 match score',
               existing_nullable=True)
    op.alter_column('candidates', 'certifications',
               existing_type=sa.ARRAY(sa.String()),
               type_=postgresql.ARRAY(sa.TEXT()),
               existing_nullable=True)
    op.alter_column('candidates', 'education',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='Degrees, universities, years',
               existing_nullable=True)
    op.alter_column('candidates', 'project_experience',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='Projects with duration and value: [{name, duration, value, role}]',
               existing_nullable=True)
    op.alter_column('candidates', 'skills_matrix',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='Detailed skills with proficiency: [{skill, proficiency, years}]',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_doc_checklist',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='Required documents: {doc_type: {required: bool, uploaded: bool, url: str}}',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_project_types',
               existing_type=sa.ARRAY(sa.String()),
               type_=postgresql.ARRAY(sa.TEXT()),
               comment=None,
               existing_comment='Project type experience',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_services',
               existing_type=sa.ARRAY(sa.String()),
               type_=postgresql.ARRAY(sa.TEXT()),
               comment=None,
               existing_comment='Services provided',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_sectors',
               existing_type=sa.ARRAY(sa.String()),
               type_=postgresql.ARRAY(sa.TEXT()),
               comment=None,
               existing_comment='Sector expertise',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_skills',
               existing_type=sa.ARRAY(sa.String()),
               type_=postgresql.ARRAY(sa.TEXT()),
               comment=None,
               existing_comment='Extracted skills',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_experience',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='AI-generated experience summary',
               existing_nullable=True)
    op.alter_column('candidates', 'ai_raw_json',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='Full Gemini API response',
               existing_nullable=True)
    op.drop_index(op.f('ix_ai_agentic_templates_org_id'), table_name='ai_agentic_templates')
    op.drop_index(op.f('ix_ai_agentic_templates_id'), table_name='ai_agentic_templates')
    op.drop_index(op.f('ix_ai_agentic_templates_category'), table_name='ai_agentic_templates')
    op.create_index(op.f('idx_ai_agentic_templates_org_id'), 'ai_agentic_templates', ['org_id'], unique=False)
    op.create_index(op.f('idx_ai_agentic_templates_is_active'), 'ai_agentic_templates', ['is_active'], unique=False)
    op.create_index(op.f('idx_ai_agentic_templates_category'), 'ai_agentic_templates', ['category'], unique=False)
    op.alter_column('ai_agentic_templates', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('ai_agentic_templates', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('ai_agentic_templates', 'assigned_modules',
               existing_type=postgresql.ARRAY(sa.String()),
               type_=postgresql.ARRAY(sa.TEXT()),
               existing_nullable=True,
               existing_server_default=sa.text("'{}'::text[]"))
    op.alter_column('ai_agentic_templates', 'tags',
               existing_type=postgresql.ARRAY(sa.String()),
               type_=postgresql.ARRAY(sa.TEXT()),
               existing_nullable=True,
               existing_server_default=sa.text("'{}'::text[]"))
    op.create_index(op.f('idx_accounts_updated_by'), 'accounts', ['updated_by'], unique=False)
    op.create_index(op.f('idx_accounts_created_by'), 'accounts', ['created_by'], unique=False)
    op.drop_index(op.f('ix_account_team_id'), table_name='account_team')
    op.drop_index(op.f('ix_account_team_employee_id'), table_name='account_team')
    op.drop_index(op.f('ix_account_team_account_id'), table_name='account_team')
    op.create_index(op.f('idx_account_team_unique'), 'account_team', ['account_id', 'employee_id'], unique=True, postgresql_where='(removed_at IS NULL)')
    op.create_index(op.f('idx_account_team_employee_id'), 'account_team', ['employee_id'], unique=False)
    op.create_index(op.f('idx_account_team_account_id'), 'account_team', ['account_id'], unique=False)
    op.create_table('password_reset_tokens',
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('otp', sa.VARCHAR(length=6), autoincrement=False, nullable=False),
    sa.Column('email', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('is_used', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=False),
    sa.Column('expires_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'), autoincrement=False, nullable=False),
    sa.Column('used_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.CheckConstraint("email::text ~ '^[^@]+@[^@]+\\.[^@]+$'::text", name=op.f('idx_password_reset_tokens_email_idx')),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('password_reset_tokens_user_id_fkey'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('password_reset_tokens_pkey')),
    sa.UniqueConstraint('user_id', 'created_at', name=op.f('idx_password_reset_tokens_user_id_idx'), postgresql_include=[], postgresql_nulls_not_distinct=False),
    comment='Stores one-time password reset OTPs with 10-minute expiry'
    )
    op.create_index(op.f('idx_password_reset_tokens_user_id'), 'password_reset_tokens', ['user_id'], unique=False)
    op.create_index(op.f('idx_password_reset_tokens_otp'), 'password_reset_tokens', ['otp'], unique=False)
    op.create_index(op.f('idx_password_reset_tokens_is_used'), 'password_reset_tokens', ['is_used'], unique=False)
    op.create_index(op.f('idx_password_reset_tokens_expires_at'), 'password_reset_tokens', ['expires_at'], unique=False)
    op.create_index(op.f('idx_password_reset_tokens_email'), 'password_reset_tokens', ['email'], unique=False)
    op.drop_index(op.f('ix_vendor_invoices_vendor_id'), table_name='vendor_invoices')
    op.drop_index(op.f('ix_vendor_invoices_status'), table_name='vendor_invoices')
    op.drop_index(op.f('ix_vendor_invoices_po_id'), table_name='vendor_invoices')
    op.drop_index(op.f('ix_vendor_invoices_org_id'), table_name='vendor_invoices')
    op.drop_index(op.f('ix_vendor_invoices_matching_status'), table_name='vendor_invoices')
    op.drop_index(op.f('ix_vendor_invoices_invoice_number'), table_name='vendor_invoices')
    op.drop_index(op.f('ix_vendor_invoices_id'), table_name='vendor_invoices')
    op.drop_index(op.f('ix_vendor_invoices_grn_id'), table_name='vendor_invoices')
    op.drop_table('vendor_invoices')
    op.drop_index(op.f('ix_rfq_responses_vendor_id'), table_name='rfq_responses')
    op.drop_index(op.f('ix_rfq_responses_status'), table_name='rfq_responses')
    op.drop_index(op.f('ix_rfq_responses_rfq_id'), table_name='rfq_responses')
    op.drop_index(op.f('ix_rfq_responses_id'), table_name='rfq_responses')
    op.drop_table('rfq_responses')
    op.drop_index(op.f('ix_procurement_budget_subcategories_subcategory_id'), table_name='procurement_budget_subcategories')
    op.drop_index(op.f('ix_procurement_budget_subcategories_id'), table_name='procurement_budget_subcategories')
    op.drop_index(op.f('ix_procurement_budget_subcategories_category_id'), table_name='procurement_budget_subcategories')
    op.drop_table('procurement_budget_subcategories')
    op.drop_index(op.f('ix_grns_status'), table_name='grns')
    op.drop_index(op.f('ix_grns_received_by'), table_name='grns')
    op.drop_index(op.f('ix_grns_po_id'), table_name='grns')
    op.drop_index(op.f('ix_grns_org_id'), table_name='grns')
    op.drop_index(op.f('ix_grns_id'), table_name='grns')
    op.drop_index(op.f('ix_grns_grn_number'), table_name='grns')
    op.drop_index(op.f('ix_grns_custom_id'), table_name='grns')
    op.drop_table('grns')
    op.drop_index(op.f('ix_delivery_milestones_status'), table_name='delivery_milestones')
    op.drop_index(op.f('ix_delivery_milestones_po_id'), table_name='delivery_milestones')
    op.drop_index(op.f('ix_delivery_milestones_id'), table_name='delivery_milestones')
    op.drop_table('delivery_milestones')
    op.drop_index(op.f('ix_rfqs_status'), table_name='rfqs')
    op.drop_index(op.f('ix_rfqs_requisition_id'), table_name='rfqs')
    op.drop_index(op.f('ix_rfqs_org_id'), table_name='rfqs')
    op.drop_index(op.f('ix_rfqs_id'), table_name='rfqs')
    op.drop_index(op.f('ix_rfqs_custom_id'), table_name='rfqs')
    op.drop_index(op.f('ix_rfqs_created_by'), table_name='rfqs')
    op.drop_table('rfqs')
    op.drop_index(op.f('ix_purchase_orders_vendor_id'), table_name='purchase_orders')
    op.drop_index(op.f('ix_purchase_orders_status'), table_name='purchase_orders')
    op.drop_index(op.f('ix_purchase_orders_requisition_id'), table_name='purchase_orders')
    op.drop_index(op.f('ix_purchase_orders_project_code'), table_name='purchase_orders')
    op.drop_index(op.f('ix_purchase_orders_org_id'), table_name='purchase_orders')
    op.drop_index(op.f('ix_purchase_orders_id'), table_name='purchase_orders')
    op.drop_index(op.f('ix_purchase_orders_custom_id'), table_name='purchase_orders')
    op.drop_index(op.f('ix_purchase_orders_created_by'), table_name='purchase_orders')
    op.drop_table('purchase_orders')
    op.drop_index(op.f('ix_procurement_budget_categories_id'), table_name='procurement_budget_categories')
    op.drop_index(op.f('ix_procurement_budget_categories_category_id'), table_name='procurement_budget_categories')
    op.drop_index(op.f('ix_procurement_budget_categories_budget_id'), table_name='procurement_budget_categories')
    op.drop_table('procurement_budget_categories')
    op.drop_index(op.f('ix_purchase_requisitions_status'), table_name='purchase_requisitions')
    op.drop_index(op.f('ix_purchase_requisitions_requested_by'), table_name='purchase_requisitions')
    op.drop_index(op.f('ix_purchase_requisitions_project_code'), table_name='purchase_requisitions')
    op.drop_index(op.f('ix_purchase_requisitions_org_id'), table_name='purchase_requisitions')
    op.drop_index(op.f('ix_purchase_requisitions_id'), table_name='purchase_requisitions')
    op.drop_index(op.f('ix_purchase_requisitions_custom_id'), table_name='purchase_requisitions')
    op.drop_table('purchase_requisitions')
    op.drop_index(op.f('ix_procurement_budgets_status'), table_name='procurement_budgets')
    op.drop_index(op.f('ix_procurement_budgets_org_id'), table_name='procurement_budgets')
    op.drop_index(op.f('ix_procurement_budgets_id'), table_name='procurement_budgets')
    op.drop_index(op.f('ix_procurement_budgets_created_by'), table_name='procurement_budgets')
    op.drop_index(op.f('ix_procurement_budgets_budget_year'), table_name='procurement_budgets')
    op.drop_table('procurement_budgets')
    op.drop_index(op.f('ix_employee_expenses_status'), table_name='employee_expenses')
    op.drop_index(op.f('ix_employee_expenses_project_code'), table_name='employee_expenses')
    op.drop_index(op.f('ix_employee_expenses_org_id'), table_name='employee_expenses')
    op.drop_index(op.f('ix_employee_expenses_id'), table_name='employee_expenses')
    op.drop_index(op.f('ix_employee_expenses_employee_id'), table_name='employee_expenses')
    op.drop_index(op.f('ix_employee_expenses_custom_id'), table_name='employee_expenses')
    op.drop_table('employee_expenses')
    # ### end Alembic commands ###


